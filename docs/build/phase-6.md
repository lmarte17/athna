# Ghost Browser — Build Plan: Phase 6

> **Active Phase:** Phase 6 — Command Bar & UX Layer
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization.  |
| **Phase 8**  | Storage Layer                          | Persistent local storage for task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                                      |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                                  |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.                                          |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                                          |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 6: Command Bar & UX Layer

**Goal:** The foreground Electron window has a polished command bar, real-time task status, and result display.

### 6.1 Command Bar — Natural Language Input

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build the command bar UI replacing the traditional address bar                                                                                                                                                                                                                                                                                                                         |
| **Actions**      | Implement a text input field at the top of the Electron foreground window. Accept free-text natural language input (no special syntax required). Support standard URL input as well (detect URLs and navigate directly). Add keyboard shortcut to focus the command bar (Cmd/Ctrl+L). Auto-clear on task submission. Display placeholder text indicating natural language is accepted. |
| **Acceptance**   | User can type "find me the best rated coffee maker under $50 on Amazon" and submit. User can also type "amazon.com" and navigate directly. Command bar is always accessible.                                                                                                                                                                                                           |
| **Req Coverage** | Spec §09 (Natural Language Input)                                                                                                                                                                                                                                                                                                                                                      |

### 6.2 Intent Classification

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Classify user input into execution paths before dispatch                                                                                                                                                                                                                                                                                                                                                                                 |
| **Actions**      | Implement classifier (can be rule-based initially, upgraded to Gemini-powered later): **NAVIGATE** — single URL destination (just go there). **RESEARCH** — multi-site information gathering (spawn Ghost Tabs). **TRANSACT** — form fill / checkout workflow. **GENERATE** — Maker Engine request (create an applet). Classification determines: whether Ghost Tabs are spawned, which engine is primary, and how results are surfaced. |
| **Acceptance**   | "google.com" → NAVIGATE (direct navigation, no Ghost Tab). "Compare prices for AirPods Pro across Amazon and Best Buy" → RESEARCH (spawn Ghost Tabs). "Fill out this contact form" → TRANSACT. "Show me a comparison chart of these products" → GENERATE.                                                                                                                                                                                |
| **Req Coverage** | Spec §09 (Intent Classification)                                                                                                                                                                                                                                                                                                                                                                                                         |

### 6.3 Task Status Feed

| Item             | Detail                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build a sidebar panel showing real-time Ghost Tab task status                                                                                                                                                                                                                                                                          |
| **Actions**      | Sidebar panel in the foreground window showing active tasks. Per task: current URL, current action description, elapsed time, progress indicator (subtask N of M), Ghost Tab state. Updates arrive via IPC at max 2Hz (cap to prevent UI jank). Sidebar is collapsible. Tasks are listed in order of creation with most recent at top. |
| **Acceptance**   | Active Ghost Tab task shows live status updates. Multiple concurrent tasks are all visible. Updates are smooth (no jank at 2Hz cap). Sidebar collapses cleanly.                                                                                                                                                                        |
| **Req Coverage** | Spec §09 (Task Status Feed)                                                                                                                                                                                                                                                                                                            |

### 6.4 Result Surface & Confidence Indicator

| Item             | Detail                                                                                                                                                                                                                                                                                                                 |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Display task results in structured result cards                                                                                                                                                                                                                                                                        |
| **Actions**      | When a task completes, display a result card in the foreground UI containing: source URLs visited, extracted data (formatted), confidence indicator (based on Navigator Engine's reported confidence), and an "Open Applet" button if a Maker Engine visualization is available. Result cards persist until dismissed. |
| **Acceptance**   | Completed research task shows result card with source URLs, extracted data, and confidence level. User can click source URLs to visit them. Applet button launches the generated visualization.                                                                                                                        |
| **Req Coverage** | Spec §09 (Result Surface)                                                                                                                                                                                                                                                                                              |

### 6.5 Ghost Tab Visibility (Read-Only)

| Item             | Detail                                                                                                                                                                                                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Allow users to peek at active Ghost Tab state                                                                                                                                                                                                                             |
| **Actions**      | Clicking a task in the status feed opens a read-only view of the Ghost Tab's current state (last captured screenshot or live view). Ghost Tab must NOT receive user input focus — read-only visibility only. Display as a picture-in-picture overlay or a separate panel. |
| **Acceptance**   | User can see what the agent is currently looking at in a Ghost Tab. User cannot accidentally interact with the Ghost Tab. View updates on each new screenshot capture.                                                                                                    |
| **Req Coverage** | Spec §09 (Ghost Tab Visibility)                                                                                                                                                                                                                                           |

### 6.6 Task Cancellation

| Item             | Detail                                                                                                                                                                                                                                                                                                               |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Enable user-initiated task cancellation at any time                                                                                                                                                                                                                                                                  |
| **Actions**      | Each task in the status feed has a cancel button. Cancellation must: (1) abort any in-flight Gemini API call, (2) close the BrowserContext (destroying all storage), (3) return a partial result if any data was extracted before cancellation. Cancellation is immediate — no waiting for current step to complete. |
| **Acceptance**   | Cancelling a running task stops it within 1 second. Partial results are displayed if available. BrowserContext is fully cleaned up.                                                                                                                                                                                  |
| **Req Coverage** | Spec §09 (Task Cancellation), §05 (Context Lifecycle — destruction)                                                                                                                                                                                                                                                  |
