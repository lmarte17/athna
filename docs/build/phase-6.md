# Ghost Browser — Build Plan: Phase 6

> **Active Phase:** Phase 6 — Command Bar & UX Layer
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data, scoped to the active top-tab context. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization. |
| **Phase 8**  | Storage Layer                          | Persistent local storage for context-scoped task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                        |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task and context events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                       |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets and measures multi-context UX overhead. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.   |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction across context switches, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                    |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 6: Command Bar & UX Layer

**Goal:** The foreground Electron window uses a dual-row workspace: top-row user context tabs plus per-context Ghost Tab rows, with a polished command bar, live status, and live ghost-surface visibility in the main browser canvas.

### Direction Update (Tabs-First + Live Ghost Surface)

Phase 6 implementation now follows a two-step UX direction before Phase 7:

1. **Tabs-first shell:** the second row is a first-class Ghost Tab row (clickable tabs, status states, dismiss completed tabs, hide cancelled tabs from the row).
2. **Live ghost surface:** selecting a Ghost Tab swaps the main browser viewport to that live agent-controlled Ghost Tab surface (not screenshot PiP), while keeping Ghost input read-only by default.

### 6.1 Command Bar — Natural Language Input

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build the Start Page command bar and top-row context-tab shell                                                                                                                                                                                                                                                                                                                           |
| **Actions**      | Keep a top row of user-facing tabs, with a Start Page as the default entry point. Place a natural-language command bar on Start Page and mirror it in the top bar for active contexts. Support free-text input (no required syntax), standard URL input (direct navigation), and an optional mode dropdown (for intent hints like Browse/Do/Make/Research) that overrides auto-classification when explicitly selected. Add Cmd/Ctrl+L focus shortcut, auto-clear after submit, and Start Page placeholder guidance. |
| **Acceptance**   | User can submit "find me the best rated coffee maker under $50 on Amazon" from Start Page and run it in the active top-tab context. User can type "amazon.com" and navigate directly. If a mode is selected in the dropdown, dispatch respects that override. Command bar remains accessible at all times.                                                                             |
| **Req Coverage** | Spec §09 (Natural Language Input)                                                                                                                                                                                                                                                                                                                                                      |

### 6.2 Intent Classification

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Classify user input into execution paths before dispatch                                                                                                                                                                                                                                                                                                                                  |
| **Actions**      | Implement classifier (can be rule-based initially, upgraded to Gemini-powered later): **NAVIGATE** — single URL destination (just go there). **RESEARCH** — multi-site information gathering (spawn Ghost Tabs). **TRANSACT** — form fill / checkout workflow. **GENERATE** — Maker Engine request (create an applet). Classifier input includes command text + active top-tab context + optional dropdown override. Classification determines whether work stays in the top tab, spawns per-context Ghost Tabs in the second row, which engine is primary, and how results are surfaced. |
| **Acceptance**   | "google.com" → NAVIGATE (direct navigation, no Ghost Tab). "Compare prices for AirPods Pro across Amazon and Best Buy" → RESEARCH (spawn Ghost Tabs under the active top tab). "Fill out this contact form" → TRANSACT. "Show me a comparison chart of these products" → GENERATE. Dropdown override can force mode when the user selects it. |
| **Req Coverage** | Spec §09 (Intent Classification)                                                                                                                                                                                                                                                                                                                                                          |

### 6.3 Task Status Feed

| Item             | Detail                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build a context-scoped task status feed and first-class second-row Ghost Tab row                                                                                                                                                                                                                                                        |
| **Actions**      | Keep the sidebar status feed, and add a second row of **clickable Ghost Tabs** beneath the top-row tabs. Each top tab owns its own Ghost Tab set and task list. Switching top tabs performs context switching: the visible Ghost row, sidebar tasks, and active Ghost selection swap to that top-tab context. Per task show current URL, current action, elapsed time, progress indicator (subtask N of M), and Ghost Tab state. Completed Ghost Tabs remain in-row until dismissed; cancelled Ghost Tabs are removed from the row and remain in status history. IPC updates are capped at 2Hz. Sidebar stays collapsible. Show background badges on top tabs for running/completed Ghost tasks in non-active contexts. |
| **Acceptance**   | Active context shows live status updates and its matching Ghost Tab row. Switching top tabs swaps to a different Ghost Tab set without cross-context leakage. Multiple concurrent tasks remain trackable through badges and context-local lists. Completed tabs can be dismissed; cancelled tabs are hidden from the row but retained in status history. Updates remain smooth at 2Hz cap. |
| **Req Coverage** | Spec §09 (Task Status Feed)                                                                                                                                                                                                                                                                                                            |

### 6.4 Result Surface & Confidence Indicator

| Item             | Detail                                                                                                                                                                                                                                                                                                                 |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Display task results in structured result cards                                                                                                                                                                                                                                                                        |
| **Actions**      | When a task completes, display a result card in the owning top-tab context containing: source URLs visited, extracted data (formatted), confidence indicator (based on Navigator Engine's reported confidence), and an "Open Applet" button if a Maker Engine visualization is available. Result cards persist until dismissed and are scoped to the context that produced them. |
| **Acceptance**   | Completed research task shows a result card with source URLs, extracted data, and confidence level in its owning context. User can click source URLs to visit them. Applet button launches the generated visualization for that context.                                                                                     |
| **Req Coverage** | Spec §09 (Result Surface)                                                                                                                                                                                                                                                                                              |

### 6.5 Ghost Tab Visibility (Live Main Surface, Read-Only by Default)

| Item             | Detail                                                                                                                                                                                                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Provide read-only live Ghost Tab visibility through context Ghost rows in the main browser viewport                                                                                                                                                                          |
| **Actions**      | Clicking a Ghost Tab in the second row swaps the main browser canvas to that Ghost Tab's live surface. Keep visibility scoped to the active top-tab context. Remove the screenshot PiP dependency for primary Ghost viewing. Enforce read-only behavior for Ghost surfaces by default (block keyboard and pointer input), while preserving a future path for explicit user takeover controls. |
| **Acceptance**   | User can inspect what the agent sees in any Ghost Tab for the active context in real time. Ghost surfaces are non-interactive by default. Switching back to a top-row context tab restores the user-controlled context surface, with no cross-context leakage.                                                     |
| **Req Coverage** | Spec §09 (Ghost Tab Visibility)                                                                                                                                                                                                                                           |

### 6.6 Task Cancellation

| Item             | Detail                                                                                                                                                                                                                                                                                                               |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Enable user-initiated task cancellation at any time                                                                                                                                                                                                                                                                  |
| **Actions**      | Each Ghost Tab/task in the context row and status feed has a cancel control. Cancellation must: (1) abort any in-flight Gemini API call, (2) close the BrowserContext (destroying all storage), (3) return a partial result if any data was extracted before cancellation, and (4) remove the canceled Ghost Tab from that context row while preserving task history/result state. Cancellation is immediate (no waiting for current step to complete). |
| **Acceptance**   | Cancelling a running task stops it within 1 second. Partial results are displayed in the owning context if available. BrowserContext is fully cleaned up and the canceled Ghost Tab is removed from the active context row.                                                    |
| **Req Coverage** | Spec §09 (Task Cancellation), §05 (Context Lifecycle — destruction)                                                                                                                                                                                                                                                  |
