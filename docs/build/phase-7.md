# Ghost Browser — Build Plan: Phase 7

> **Active Phase:** Phase 7 — Maker Engine & Applets
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 6**  | Command Bar & UX Layer                 | Foreground UI adopts a dual-row workspace: top-row user context tabs and per-context Ghost Tab rows, with natural-language command bar, context switching, live status, read-only Ghost visibility, and cancellation.                                            |
| **Phase 8**  | Storage Layer                          | Persistent local storage for context-scoped task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                        |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task and context events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                       |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets and measures multi-context UX overhead. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.   |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction across context switches, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                    |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 7: Maker Engine & Applets

**Goal:** The system can generate interactive single-use applets from aggregated task data and display them safely in the foreground, scoped to the active top-tab context.

### 7.1 Applet Brief Schema

| Item             | Detail                                                                                                                                                                                                                                                                                  |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Define and implement the structured input format for the Maker Engine                                                                                                                                                                                                                   |
| **Actions**      | Input schema: `{contextId: string, intent: string, dataType: string, data: object[], sourceTaskIds: string[], visualizationHint: string, constraints: string[]}`. No raw HTML or screenshots as input (prevents prompt injection via web-scraped content). Data must be pre-sanitized (HTML-escaped) before inclusion in the brief. |
| **Acceptance**   | Maker Engine receives a clean structured brief with required `contextId` and `sourceTaskIds`. Raw HTML from scraped pages is never included. Schema validation rejects malformed briefs.                                                                                                 |
| **Req Coverage** | Spec §08.2 (Applet Brief Schema)                                                                                                                                                                                                                                                        |

### 7.2 Maker Engine — Applet Generation

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                      |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Implement the Maker Engine that generates HTML/JS/CSS applets from structured data                                                                                                                                                                                                                                                                                                                          |
| **Actions**      | System prompt instructs Gemini to generate a single self-contained HTML string with inline CSS and JS. Data is injected as `const DATA = {...}` at the top of the generated script (model does not embed data inline in markup). Model generates visualization code that reads from the DATA constant. Bind generated output to the originating `contextId` and support retry: if output validation fails, append error context to prompt and retry (max 2 retries). |
| **Acceptance**   | Given a brief with price comparison data, the Maker Engine generates a working HTML applet with a sortable comparison table. Applet renders correctly when loaded in an iframe and is attached to the originating top-tab context.                                                                                                                                 |
| **Req Coverage** | Spec §08.2 (Maker Engine, Data Injection)                                                                                                                                                                                                                                                                                                                                                                   |

### 7.3 Applet Output Validation (3-Layer)

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Validate generated applet HTML before sandbox injection                                                                                                                                                                                                                                                                                                                                                                               |
| **Actions**      | Three validation layers: (1) **HTML parse validation** — generated string must parse as valid HTML. (2) **API allowlist check** — scan the JS for prohibited APIs: `fetch`, `XMLHttpRequest`, `WebSocket`, `localStorage`, `document.cookie`, `window.parent`, and privileged context bridges (for example `window.electronAPI`). Reject if any found. (3) **Size check** — applet must be < 100KB. Any validation failure triggers a retry with the specific error appended to the Maker Engine prompt. |
| **Acceptance**   | Valid applet passes all three checks. Applet containing `fetch()` or privileged bridge access is rejected at layer 2. Applet exceeding 100KB is rejected at layer 3. Failed validations trigger retries with error context.                                                                                                                             |
| **Req Coverage** | Spec §08.2 (Output Validation), §03 (Applet Generation Contract — prohibited APIs)                                                                                                                                                                                                                                                                                                                                                    |

### 7.4 Applet Sandbox — iframe Isolation & CSP

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Run applets in a sandboxed iframe with strict security policies                                                                                                                                                                                                                                                                                                                                                       |
| **Actions**      | Create iframe with sandbox attributes: `allow-scripts` only. Explicitly NO: `allow-same-origin`, `allow-forms`, `allow-popups`, `allow-top-navigation`. Inject Content Security Policy via meta tag or HTTP header: `default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'`. Exception: Chart.js CDN loading requires `script-src 'unsafe-inline' https://cdn.jsdelivr.net` (or bundle Chart.js). |
| **Acceptance**   | Applet JS runs inside the iframe. Applet cannot access parent window, cookies, localStorage, or make outbound requests. CSP blocks any external resource loading (except allowed CDN).                                                                                                                                                                                                                                |
| **Req Coverage** | Spec §03 (Applet Sandbox — Execution, CSP)                                                                                                                                                                                                                                                                                                                                                                            |

### 7.5 Applet Lifecycle Management

| Item             | Detail                                                                                                                                                                                                                                                                                                             |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Manage mounting, unmounting, and lifecycle of applets in the foreground                                                                                                                                                                                                                                            |
| **Actions**      | Maximum one active applet per top-tab context at a time. Mount: inject validated HTML into sandbox iframe in the foreground window for that context. Unmount: remove iframe from DOM, discard all applet state. Applet state is never preserved across unmounts (single-use). On top-tab context switch, hide the previous context applet and show the selected context applet state (or none). Provide UI controls: close applet, full-screen applet. |
| **Acceptance**   | Applet mounts and renders correctly in its owning context. Mounting a new applet in the same context unmounts the previous one. Switching top tabs never leaks applet state across contexts. Close button fully removes the applet.                                                                              |
| **Req Coverage** | Spec §03 (Applet Lifecycle)                                                                                                                                                                                                                                                                                        |

### 7.6 Visualization Types

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Ensure the Maker Engine supports the minimum required visualization types                                                                                                                                                                                                                                                                                                        |
| **Actions**      | Required types: (1) **Sortable comparison tables** — HTML table with column sort. (2) **Charts** — line, bar, pie via inline Chart.js (loaded from CDN or bundled). (3) **Filterable card grids** — card layout with text filter/search. Additional types generated freeform by the model based on the visualization hint in the brief. Test each type with representative data. |
| **Acceptance**   | Price comparison → sortable table. Historical price data → line chart. Product listings → filterable card grid. All types render correctly in the sandbox.                                                                                                                                                                                                                       |
| **Req Coverage** | Spec §08.2 (Visualization Types)                                                                                                                                                                                                                                                                                                                                                 |

### 7.7 Data Injection & Sanitization

| Item             | Detail                                                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Ensure data is safely injected into applets                                                                                                                                                                                                                                                                                     |
| **Actions**      | All structured data from task results is HTML-escaped before injection into the `const DATA = {...}` declaration. Sanitization covers: `<`, `>`, `&`, `"`, `'`, backtick. Include minimal context metadata (`CONTEXT_META`) for display logic without exposing cross-context data. Verify sanitized data renders correctly in the applet (no double-escaping). Data injection is done by the orchestration layer, not by the model. |
| **Acceptance**   | Data containing HTML tags (e.g., product names with `<b>`) is escaped and renders as literal text, not markup. Applet can read only its own context metadata. No XSS vectors in injected data.                                                                                                                              |
| **Req Coverage** | Spec §08.2 (Data Injection)                                                                                                                                                                                                                                                                                                     |
