# Ghost Browser — Build Plan: Phase 2

> **Active Phase:** Phase 2 — Perception Reliability & Model Routing
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                  | Summary                                                                                                                                                                                                                                                          |
| ------------ | ------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop           | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 3**  | Ghost Tab Pool & Parallelism          | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced           | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 5**  | Networking Optimizations              | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 6**  | Command Bar & UX Layer                | The foreground Electron window gains a polished natural-language command bar, intent classification, a real-time task status sidebar, result cards with confidence indicators, ghost tab peek view, and task cancellation.                                       |
| **Phase 7**  | Maker Engine & Applets                | Generates interactive single-use HTML/JS/CSS applets from structured task data. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization.  |
| **Phase 8**  | Storage Layer                         | Persistent local storage for task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                                      |
| **Phase 9**  | Cloud Deployment & Infrastructure     | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                                  |
| **Phase 10** | Performance Tuning & Observability    | Meets all spec performance targets. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.                                          |
| **Phase 11** | Security Hardening                    | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                                          |
| **Phase 12** | Demo, Submission & Polish             | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 2: Perception Reliability & Model Routing

**Goal:** The agent handles ambiguous pages, AX-deficient pages, and scrolling correctly. Vision (screenshots) is used as a fallback. Model routing between Flash and Pro is implemented.

### 2.1 Tiered Perception Protocol

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Implement the three-tier perception decision tree                                                                                                                                                                                                                                                                                                                                                                               |
| **Actions**      | **Tier 1:** AX tree + interactive element index → Gemini Flash. Cost target: ~$0.00015/call (~4K tokens). **Tier 2:** AX tree + viewport screenshot → Gemini Pro. Cost target: ~$0.003/call. **Tier 3:** Scroll 800px → re-run from Tier 1. Implement the orchestration logic that tries Tier 1 first, escalates on low confidence or AX deficiency, and scrolls as a last resort. Track tier usage per task for cost analysis. |
| **Acceptance**   | Well-labeled page (e.g., Google) resolves at Tier 1. Ambiguous page (confidence < 0.75) escalates to Tier 2. Canvas-heavy page skips directly to Tier 2. All tiers produce valid actions or escalate correctly.                                                                                                                                                                                                                 |
| **Req Coverage** | Spec §04 (Tiered Perception Protocol, Tiered Perception Decision Matrix)                                                                                                                                                                                                                                                                                                                                                        |

### 2.2 Confidence Threshold & Escalation

| Item             | Detail                                                                                                                                                                                                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Enforce the 0.75 confidence threshold for Tier 1 → Tier 2 escalation                                                                                                                                                                                                      |
| **Actions**      | Navigator Engine already returns `confidence` in its action schema. Orchestration layer checks: if `confidence < 0.75`, capture viewport screenshot and re-invoke with Gemini Pro (Tier 2). Log every escalation with page URL, confidence score, and tier that resolved. |
| **Acceptance**   | Pages with clear ARIA labels and familiar layouts resolve at Tier 1 (confidence ≥ 0.75). Pages with generic labels or unusual layouts trigger Tier 2 escalation. No actions are executed with confidence below threshold without escalation.                              |
| **Req Coverage** | Spec §04 (Confidence Threshold), §08.1 (Model Routing)                                                                                                                                                                                                                    |

### 2.3 AX-Deficient Page Detection

| Item             | Detail                                                                                                                                                                                                                                                                            |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Detect pages where the AX tree is insufficient and skip directly to Tier 2                                                                                                                                                                                                        |
| **Actions**      | After AX tree normalization, count interactive elements. If count < 5 AND the page has significant visual content (determined by page load status being complete), flag as AX-deficient. Route directly to Tier 2, bypassing the Flash call. Log AX-deficient pages for analysis. |
| **Acceptance**   | Canvas-heavy apps (e.g., Figma landing page), custom web component frameworks, and flash-based legacy sites are detected as AX-deficient. Standard HTML pages with proper ARIA are not falsely flagged.                                                                           |
| **Req Coverage** | Spec §04 (Canvas & Custom Component Fallback)                                                                                                                                                                                                                                     |

### 2.4 Scroll Control & Above-the-Fold Heuristic

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Implement scroll-based exploration with the above-the-fold optimization                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Actions**      | Before a full-page screenshot, capture only the viewport. Pass to model. If model returns SCROLL action, execute scroll of 800px (11% overlap with previous viewport). Re-capture and re-infer. Track scroll steps; abort after 8 steps with FAILED status and page URL for manual review. Implement scroll position query: `Runtime.evaluate('window.scrollY')`. Use scroll position + viewport height to determine if target might be below fold before issuing another screenshot. |
| **Acceptance**   | Target element within first viewport is found without scrolling. Target below fold triggers scroll + re-perception. Infinite-scroll pages abort after 8 steps.                                                                                                                                                                                                                                                                                                                        |
| **Req Coverage** | Spec §02 (Scroll Control, Above-the-Fold Heuristic, Partial Render Trigger), §04 (Tiered Perception — scroll tier)                                                                                                                                                                                                                                                                                                                                                                    |

### 2.5 AX Tree Staleness Detection

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Detect DOM mutations after agent actions and re-fetch the AX tree when needed                                                                                                                                                                                                                                                                                                                                            |
| **Actions**      | After each action (especially CLICK), inject a `MutationObserver` via `Runtime.evaluate` that watches for structural DOM changes (childList mutations, attribute changes on interactive elements). If significant mutations detected within 2 seconds post-action, re-extract the AX tree before next perception cycle. Define "significant" as: ≥ 3 added/removed nodes, or any change to nodes with interactive roles. |
| **Acceptance**   | Clicking a dropdown triggers AX tree re-fetch (new options appear). Clicking a static link does not trigger unnecessary re-fetch. Dynamic content loading (AJAX) is caught and triggers re-perception.                                                                                                                                                                                                                   |
| **Req Coverage** | Spec §04 (AX Tree Staleness Detection)                                                                                                                                                                                                                                                                                                                                                                                   |

### 2.6 DOM Extraction via JS (Vision Bypass)

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Use lightweight JS injection to extract element data, potentially bypassing the vision model entirely                                                                                                                                                                                                                                                                                                                          |
| **Actions**      | Before issuing a screenshot (Tier 2), run a DOM extraction script via `Runtime.evaluate` that returns: `{elements: [{tag, text, boundingBox, isVisible, isInteractive}]}` for all visible interactive elements. If the target element can be identified unambiguously by text content + bounding box from this extraction, skip the vision model call entirely. This is a cost optimization sitting between Tier 1 and Tier 2. |
| **Acceptance**   | On a page where AX tree is ambiguous but DOM text is clear, the DOM extraction script resolves the target without a Gemini Pro call. Cost savings are logged.                                                                                                                                                                                                                                                                  |
| **Req Coverage** | Spec §03 (DOM Extraction via JS), §04 (optimization layer)                                                                                                                                                                                                                                                                                                                                                                     |
