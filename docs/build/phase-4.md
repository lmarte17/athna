# Ghost Browser — Build Plan: Phase 4

> **Active Phase:** Phase 4 — Navigator Engine — Advanced
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 6**  | Command Bar & UX Layer                 | The foreground Electron window gains a polished natural-language command bar, intent classification, a real-time task status sidebar, result cards with confidence indicators, ghost tab peek view, and task cancellation.                                       |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization.  |
| **Phase 8**  | Storage Layer                          | Persistent local storage for task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                                      |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                                  |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.                                          |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                                          |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 4: Navigator Engine — Advanced

**Goal:** The Navigator Engine handles complex multi-step tasks, manages context windows, and uses observation caching.

### 4.1 Context Window Management

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Maintain a rolling context window of recent actions and observations                                                                                                                                                                                                                                                                                                                           |
| **Actions**      | Keep the last 5 action+observation pairs in the context sent to the model. Older history is summarized: compress into a 2-3 sentence summary of what was accomplished and what the current state is. Implement summarization as a lightweight Gemini Flash call (or template-based if deterministic enough). Monitor total token count sent per call; alert if exceeding model context limits. |
| **Acceptance**   | A 15-step task doesn't overflow the model context. Summarized history preserves goal-relevant information. Token cost per call remains bounded.                                                                                                                                                                                                                                                |
| **Req Coverage** | Spec §08.1 (Context Window Management)                                                                                                                                                                                                                                                                                                                                                         |

### 4.2 Task Decomposition & Checkpointing

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | For complex intents, decompose into ordered subtasks with checkpoint-aware recovery (v1 sequential scope)                                                                                                                                                                                                                                                                                      |
| **Actions**      | If an intent implies > 2 steps, run a decomposition pass that returns an ordered subtask list. Each subtask includes: `id`, `intent`, optional `startUrl`, `verification` (`type` + `condition`), and runtime `status` (`PENDING`, `IN_PROGRESS`, `COMPLETE`, `FAILED`). Persist a task-local checkpoint object after each completed subtask: `{lastCompletedSubtaskIndex, subtaskArtifacts, currentSubtaskAttempt}`. On failure, retry only the current failed subtask from checkpoint; do not restart completed subtasks. Publish subtask progress to task status feed by extending the typed status channel with a `SUBTASK` payload (subtask id/status and `currentSubtaskIndex` of `totalSubtasks`). v1 excludes parallel DAG execution, multi-plan fallbacks, and human-handoff workflow orchestration. |
| **Acceptance**   | "Find the cheapest flight from NYC to London next Friday on Google Flights" decomposes into ~5 sequential subtasks. Failure at subtask 4 retries subtask 4 from checkpoint while subtasks 1-3 remain `COMPLETE` and are not re-run. Subtask list and status transitions are visible in task status feed. Result artifacts include subtask timeline and checkpoint metadata.                                |
| **Req Coverage** | Spec §08.1 (Task Decomposition)                                                                                                                                                                                                                                                                                                                                                                |

### 4.3 Error Handling — Structured Error Objects

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Surface all errors to the Navigator Engine as structured objects, not raw HTML                                                                                                                                                                                                                                                                                                                                                   |
| **Actions**      | Network errors, JS runtime errors, CDP errors, and timeout errors are all caught by the orchestration layer. Convert to: <code>{type: NETWORK &#124; RUNTIME &#124; CDP &#124; TIMEOUT, status: number &#124; null, url: string, message: string, retryable: boolean}</code>. Navigator Engine receives these instead of error page screenshots. Engine decides: retry, navigate away, or escalate to screenshot-based approach. |
| **Acceptance**   | A 404 page produces a structured error (not a screenshot of the 404 page). A JS runtime error in a Ghost Tab is caught and structured. The Navigator Engine can make retry decisions based on the `retryable` flag.                                                                                                                                                                                                              |
| **Req Coverage** | Spec §01 (Error Handling), §03 (Error Isolation), §08.1 (error handling behavior)                                                                                                                                                                                                                                                                                                                                                |

### 4.4 Observation Cache

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Cache perception results within a task session to avoid redundant rendering and inference                                                                                                                                                                                                                                                                                                                               |
| **Actions**      | Maintain an in-memory cache: `{url → {axtree_hash, screenshot_b64, interactive_elements, timestamp, ttl}}`. Default TTL: 60 seconds. Cache is per-task-session — discarded when task completes. Before running perception, check cache: if URL matches and TTL is valid and page hasn't navigated, reuse cached perception data. Especially valuable for form flows and multi-step checkouts that revisit the same URL. |
| **Acceptance**   | Revisiting the same URL within 60s during a form flow reuses cached AX tree (no re-extraction or re-inference). Cache is empty after task completion.                                                                                                                                                                                                                                                                   |
| **Req Coverage** | Spec §07 (Observation Cache)                                                                                                                                                                                                                                                                                                                                                                                            |
