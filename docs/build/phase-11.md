# Ghost Browser — Build Plan: Phase 11

> **Active Phase:** Phase 11 — Security Hardening
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                 |
| **Phase 6**  | Command Bar & UX Layer                 | Foreground UI adopts a dual-row workspace: top-row user context tabs and per-context Ghost Tab rows, with natural-language command bar, context switching, live status, read-only Ghost visibility, and cancellation.                                            |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data, scoped to the active top-tab context. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization. |
| **Phase 8**  | Storage Layer                          | Persistent local storage for context-scoped task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                        |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task and context events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                       |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets and measures multi-context UX overhead. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.   |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 11: Security Hardening

**Goal:** All security requirements from the spec are enforced, including hard context boundaries in the dual-row workspace. Defense-in-depth for generated code and user data.

### 11.1 Applet JS API Allowlist Enforcement

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Harden the JS API allowlist check for generated applets                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Actions**      | Implement a robust scanner (not just string search — use AST parsing if feasible, or at minimum regex with word boundaries) for prohibited APIs: `fetch`, `XMLHttpRequest`, `WebSocket`, `localStorage`, `sessionStorage`, `document.cookie`, `window.parent`, `window.top`, `window.opener`, privileged context bridges (for example `window.electronAPI`), `eval` (beyond what's already inline), `Function()` constructor. Combine with CSP enforcement (belt and suspenders). Test with adversarial applet code that tries to bypass detection. |
| **Acceptance**   | Applets using prohibited APIs are rejected before injection. Obfuscated attempts (e.g., `window['par'+'ent']`) are caught by CSP as a fallback. No unauthorized network requests, privileged bridge calls, or cross-context data access from applet code.                                                                                                                                                                             |
| **Req Coverage** | Spec §03 (Applet Generation Contract, Applet Sandbox — CSP), §08.2 (Output Validation)                                                                                                                                                                                                                                                                                                                                                                                               |

### 11.2 BrowserContext Lifecycle Enforcement

| Item             | Detail                                                                                                                                                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Ensure BrowserContexts are always destroyed on task completion or cancellation                                                                                                                                                                                                            |
| **Actions**      | Add lifecycle hooks: on COMPLETE, FAILED, CANCEL, or top-tab close → destroy BrowserContext. Add a cleanup sweep on app shutdown that destroys any lingering contexts. Verify no residual auth tokens, cookies, or form data persist after context destruction. Add integration tests for lifecycle events across context switching and top-tab closure. |
| **Acceptance**   | No BrowserContexts leak beyond task lifetime or closed top-tab contexts. App shutdown cleans up all contexts. No residual data after destruction.                                                                                                                                            |
| **Req Coverage** | Spec §05 (Context Lifecycle)                                                                                                                                                                                                                                                              |

### 11.3 Cookie Passthrough Consent UX

| Item             | Detail                                                                                                                                                                                                                                                                                                                |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build the user permission flow for cookie passthrough                                                                                                                                                                                                                                                                 |
| **Actions**      | When a task requires authenticated access to a domain, display a permission dialog: "Ghost Browser needs to use your [domain] session for this task in [context]. Allow?" Permission is per-domain, per-context, and per-task (not persisted). Show clear visual indicators of domains with active cookie passthrough in each context. Log all consent grants with context metadata. |
| **Acceptance**   | User sees a clear permission dialog before any cookies are cloned. Permission is per-domain, per-context, and per-task. Denied permission prevents cookie cloning (task proceeds without auth).                                                                                                                               |
| **Req Coverage** | Spec §07 (Cookie / Auth Passthrough — UX), Spec Appendix (Auth Cookie Passthrough UX open question)                                                                                                                                                                                                                   |

### 11.4 Error Isolation (Renderer Crashes)

| Item             | Detail                                                                                                                                                                                                                                                                               |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Verify that Ghost Tab crashes are fully isolated                                                                                                                                                                                                                                     |
| **Actions**      | Simulate renderer crashes (kill renderer process, trigger OOM, execute crashing JS). Verify: other Ghost Tabs in the same or different contexts are unaffected, foreground window is unaffected, orchestration layer receives crash event and handles recovery. No unhandled exceptions propagate to the main process. |
| **Acceptance**   | Crashing one Ghost Tab has zero impact on other Ghost Tabs, other top-tab contexts, or the foreground. All crashes are caught and handled by the crash recovery system (Phase 3.7).                                                                                                   |
| **Req Coverage** | Spec §03 (Error Isolation), §05 (Crash Recovery)                                                                                                                                                                                                                                     |
