# Ghost Browser — Build Plan: Phase 1

> **Active Phase:** Phase 1 — Core Perception–Action Loop
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                         |
| ------------ | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                        |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                           |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                       |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                         |
| **Phase 5**  | Networking Optimizations               | Ghost Tabs load faster through request interception/asset filtering, connection pool isolation, predictive prefetch, structured network error handling, and per-context HTTP cache partitioning.                                                                |
| **Phase 6**  | Command Bar & UX Layer                 | The foreground Electron window gains a polished natural-language command bar, intent classification, a real-time task status sidebar, result cards with confidence indicators, ghost tab peek view, and task cancellation.                                      |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization. |
| **Phase 8**  | Storage Layer                          | Persistent local storage for task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                                     |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                                 |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.                                         |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                                         |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                     |

---

## Phase 1: Core Perception–Action Loop

**Goal:** A single Ghost Tab can load a page, perceive it (AX tree), send perception to Gemini, receive an action, execute it via CDP, and loop. This is the foundational agent loop.

### 1.1 CDP Client Setup

| Item             | Detail                                                                                                                                                                                                                                                                                                                                 |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Connect `playwright-core` (or `puppeteer-core`) to the headless Electron BrowserWindow via CDP                                                                                                                                                                                                                                         |
| **Actions**      | Install `playwright-core` (no browser download). Launch a headless BrowserWindow from Electron's main process. Obtain the CDP WebSocket endpoint. Connect playwright-core to it. Verify `Page.navigate` works — navigate to a known URL (e.g., `https://www.google.com`). Verify `Page.captureScreenshot` returns a valid JPEG buffer. |
| **Acceptance**   | Navigating to a URL completes with `loadEventFired`. Screenshot saved to disk matches the expected page.                                                                                                                                                                                                                               |
| **Req Coverage** | Spec §06 (`Page.navigate`, `Page.captureScreenshot`), Spec §02 (Headless Rendering — partial)                                                                                                                                                                                                                                          |

### 1.2 Headless Rendering Configuration

| Item             | Detail                                                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Configure Ghost Tab headless rendering per spec: disable GPU compositing, set viewport, configure screenshot params                                                                                                                                                                                                             |
| **Actions**      | Set headless BrowserWindow flags: `--headless=new`, `--disable-gpu`, offscreen rendering enabled. Set default viewport to **1280×900** at device scale factor 1.0. Configure `Page.captureScreenshot` defaults: format JPEG, quality 80, `fromSurface: true`. Verify viewport-only screenshot output dimensions match 1280×900. |
| **Acceptance**   | Ghost Tab runs without GPU process. Screenshots are 1280×900 JPEG at ~80 quality. Memory per Ghost Tab is measurably lower than a full-render window.                                                                                                                                                                           |
| **Req Coverage** | Spec §02 (Headless Rendering Mode, Viewport Configuration, Screenshot Capture)                                                                                                                                                                                                                                                  |

### 1.3 Screenshot Capture Pipeline

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Build the screenshot utility with configurable clip region, quality, and full-page support                                                                                                                                                                                                                                                                                                     |
| **Actions**      | Implement `captureScreenshot(options)` function wrapping CDP `Page.captureScreenshot`. Support modes: `viewport` (default) and `full-page` (scroll-and-stitch). Full-page mode scrolls in 800px steps with 11% overlap, captures each viewport, and stitches vertically. Cap full-page at 8 scroll steps (abort + flag if exceeded). Return screenshot as base64 string ready for model input. |
| **Acceptance**   | Viewport screenshot returns a single 1280×900 image. Full-page screenshot on a long page returns a stitched image spanning multiple viewport heights. Infinite-scroll pages abort after 8 steps with an appropriate flag.                                                                                                                                                                      |
| **Req Coverage** | Spec §02 (Screenshot Capture, Full-page scroll step, Max scroll steps, Above-the-Fold Heuristic — partial)                                                                                                                                                                                                                                                                                     |

### 1.4 Accessibility Tree Extraction & Normalization

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Extract and normalize the AX tree from any loaded page                                                                                                                                                                                                                                                                                                                                                                          |
| **Actions**      | Call CDP `Accessibility.getFullAXTree` after `loadEventFired + DOMContentLoaded`. Implement normalization that prunes the raw tree: retain only `nodeId`, `role`, `name`, `value`, `description`, `states[]`, `boundingBox`. Remove irrelevant roles: `generic`, `none`, `presentation`, `InlineTextBox`, etc. Target: raw tree of 50K+ chars → normalized JSON < 8,000 characters. Measure normalization time; flag if > 15ms. |
| **Acceptance**   | Normalized AX tree for amazon.com product page fits within ~8K chars. All interactive elements (buttons, links, inputs) are preserved with bounding boxes. Pruned roles do not appear in output.                                                                                                                                                                                                                                |
| **Req Coverage** | Spec §04 (AX Tree Extraction, AX Tree Normalization)                                                                                                                                                                                                                                                                                                                                                                            |

### 1.5 Interactive Element Index

| Item             | Detail                                                                                                                                                                                                                                                                                                       |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Build a filtered index of only interactive elements from the normalized AX tree                                                                                                                                                                                                                              |
| **Actions**      | From the normalized tree, extract elements with roles: `button`, `link`, `textbox`, `combobox`, `checkbox`, `radio`, `menuitem`, `tab`, `searchbox`, `spinbutton`, `slider`, `switch`. Store as flat array: `{nodeId, role, name, value, boundingBox}`. This is the "fast-pass" input for Tier 1 perception. |
| **Acceptance**   | Interactive element index for a typical e-commerce page contains 20-80 elements. Index is a fraction of the full normalized tree size.                                                                                                                                                                       |
| **Req Coverage** | Spec §04 (Interactive Element Index)                                                                                                                                                                                                                                                                         |

### 1.6 Navigator Engine — Single-Model (Flash)

| Item             | Detail                                                                                                                                                                                                                                                                                      |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------ | ---- | ------- | ---- | ---------------------- | ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Implement the first version of the Navigator Engine using Gemini Flash only                                                                                                                                                                                                                 |
| **Actions**      | Design the system prompt for the Navigator Engine. It receives: (1) the user's intent, (2) the normalized AX tree or interactive element index, and (3) optional previous actions/observations. It must return a response conforming to the **typed action schema**: `{action: CLICK        | TYPE | SCROLL | WAIT | EXTRACT | DONE | FAILED, target: {x, y} | null, text: string | null, confidence: 0.0-1.0, reasoning: string}`. Use Gemini Flash for all calls in this phase. Parse the structured JSON response and validate against the schema. Handle malformed responses with a retry (max 1 retry). |
| **Acceptance**   | Given an AX tree from Google's homepage and intent "search for mechanical keyboards", the engine returns `{action: CLICK, target: {x, y}, confidence: 0.9+}` pointing to the search box. Subsequent calls with updated AX trees produce TYPE and CLICK actions to complete the search flow. |
| **Req Coverage** | Spec §08.1 (Navigator Engine — Action Schema, Model Routing — Flash only for now)                                                                                                                                                                                                           |

### 1.7 CDP Action Execution

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Translate Navigator Engine action outputs into CDP commands                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Actions**      | Implement action executor that maps the action schema to CDP calls: `CLICK` → `Input.dispatchMouseEvent` (mousemove to target, then mousedown + mouseup at `{x, y}`). `TYPE` → `Input.dispatchKeyEvent` (type: char for each character in `text`, plus special keys Enter/Tab/Escape via keyDown/keyUp). `SCROLL` → `Input.dispatchMouseEvent` (scroll) or `Runtime.evaluate(window.scrollBy(...))`. `WAIT` → setTimeout/delay. `EXTRACT` → `Runtime.evaluate` to extract target data. `DONE` → signal task completion. `FAILED` → signal task failure. All actions must wait for any resulting navigation or DOM update before returning. |
| **Acceptance**   | CLICK on a search box focuses the element. TYPE fills in text. SCROLL moves the viewport. EXTRACT returns structured data from the page. Full loop: navigate → perceive → act → repeat until DONE.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Req Coverage** | Spec §06 (`Input.dispatchMouseEvent`, `Input.dispatchKeyEvent`, `Runtime.evaluate`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

### 1.8 Loop Integration & Manual Testing

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Wire the full perception-action loop together and test end-to-end                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Actions**      | Build the loop orchestrator: (1) navigate to starting URL, (2) wait for load, (3) extract AX tree, (4) send to Navigator Engine, (5) execute returned action, (6) detect page state change, (7) repeat from step 3 until DONE/FAILED or max steps reached. Set max steps per task to 20 (safety limit). Add console logging at each step: intent, action taken, confidence, current URL. Test against 3 representative sites: Google Search, Amazon product search, Wikipedia navigation. |
| **Acceptance**   | "Search for mechanical keyboards on Amazon" completes: navigates to amazon.com, types in search box, submits, arrives at search results page. All steps logged. Loop terminates cleanly on DONE.                                                                                                                                                                                                                                                                                          |
| **Req Coverage** | Spec §05 (Ghost Tab State Machine — LOADING → PERCEIVING → INFERRING → ACTING → COMPLETE), §08.1 (Navigator Engine end-to-end)                                                                                                                                                                                                                                                                                                                                                            |
