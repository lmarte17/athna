# Ghost Browser — Build Plan: Phase 5

> **Active Phase:** Phase 5 — Networking Optimizations
> Full build plan: [build-plan.md](./build-plan.md)

---

## Other Phases at a Glance

| Phase        | Goal                                   | Summary                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Phase 0**  | Project Scaffolding & Dev Environment  | Establishes the monorepo structure, Electron shell, and a working Gemini SDK integration spike. The output is a working Electron app that can call Gemini API — no agentic behavior yet.                                                                         |
| **Phase 1**  | Core Perception–Action Loop            | A single Ghost Tab loads a page, perceives it via the AX tree, sends perception to Gemini, receives an action, executes it via CDP, and loops. Covers CDP client setup, screenshot pipeline, AX tree extraction, Navigator Engine (Flash), and action execution. |
| **Phase 2**  | Perception Reliability & Model Routing | Handles ambiguous pages, AX-deficient pages, and scrolling correctly. Implements the three-tier perception protocol, confidence thresholding, staleness detection, and a DOM-extraction bypass layer.                                                            |
| **Phase 3**  | Ghost Tab Pool & Parallelism           | Multiple Ghost Tabs run concurrently with full BrowserContext isolation, a warm pool manager, a formal state machine, typed IPC messages, parallel task scheduling, resource budgets, and crash recovery.                                                        |
| **Phase 4**  | Navigator Engine — Advanced            | The Navigator Engine handles complex multi-step tasks via context window rolling, task decomposition with checkpointing, structured error objects, and an in-session observation cache.                                                                          |
| **Phase 6**  | Command Bar & UX Layer                 | The foreground Electron window gains a polished natural-language command bar, intent classification, a real-time task status sidebar, result cards with confidence indicators, ghost tab peek view, and task cancellation.                                       |
| **Phase 7**  | Maker Engine & Applets                 | Generates interactive single-use HTML/JS/CSS applets from structured task data. Covers the applet brief schema, generation via Gemini, 3-layer output validation, sandboxed iframe execution, lifecycle management, visualization types, and data sanitization.  |
| **Phase 8**  | Storage Layer                          | Persistent local storage for task results and applets, verified session isolation, SQLite task store, applet output persistence, cookie/auth passthrough with consent UX, and SQLCipher encryption at rest.                                                      |
| **Phase 9**  | Cloud Deployment & Infrastructure      | Cloud Run Gemini API proxy, OIDC authentication, Cloud Logging for task events, auto-scaling configuration, and full Terraform IaC for reproducible deployment.                                                                                                  |
| **Phase 10** | Performance Tuning & Observability     | Meets all spec performance targets. Enables CDP Performance domain metrics, benchmarks TTFB/load/memory targets, profiles AX tree normalization, and implements Gemini API rate limit queuing with exponential backoff.                                          |
| **Phase 11** | Security Hardening                     | Hardens the JS API allowlist (AST-level scanning), enforces BrowserContext lifecycle destruction, builds the cookie passthrough consent UX, and stress-tests Ghost Tab crash isolation.                                                                          |
| **Phase 12** | Demo, Submission & Polish              | Everything needed for hackathon submission: demo video, architecture diagram, README, proof of GCP deployment, written description, and optional blog post and GDG profile.                                                                                      |

---

## Phase 5: Networking Optimizations

**Goal:** Ghost Tabs load faster by blocking unnecessary assets, pre-warming connections, and handling network errors intelligently.

### 5.1 Request Interception & Asset Filtering

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Block images, fonts, and media in Ghost Tabs by default                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Actions**      | Use CDP `Network.setRequestInterception` (or Fetch.enable) to intercept all outbound requests in Ghost Tabs. Block resource types: `Image`, `Font`, `Media`, `Stylesheet` (optional — may be needed for layout). Allow: `Document`, `Script`, `XHR`, `Fetch`. Re-enable assets only when the Navigator Engine explicitly requests a visual render pass (Tier 2 screenshot). Classify requests at intercept time: decide if full HTML fetch or lightweight JSON/API response suffices. |
| **Acceptance**   | Ghost Tab page load time is reduced by ≥ 40% on media-heavy pages (measure against Amazon, news sites). Re-enabling assets for screenshot produces correct visual output.                                                                                                                                                                                                                                                                                                             |
| **Req Coverage** | Spec §01 (Request Interception, Asset Filtering), Performance target (≥ 40% load time reduction)                                                                                                                                                                                                                                                                                                                                                                                      |

### 5.2 Connection Pool Isolation

| Item             | Detail                                                                                                                                                                                                                                                 |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Ensure each Ghost Tab BrowserContext has an isolated connection pool                                                                                                                                                                                   |
| **Actions**      | Verify that Electron's `session.fromPartition` creates isolated network stacks. Confirm connections are not shared across Ghost Tabs. Test: two Ghost Tabs accessing the same site use separate TCP connections (no connection reuse across contexts). |
| **Acceptance**   | Network isolation confirmed via CDP Network domain inspection. No state leakage between Ghost Tab sessions.                                                                                                                                            |
| **Req Coverage** | Spec §01 (Connection Pool)                                                                                                                                                                                                                             |

### 5.3 Predictive Prefetch

| Item             | Detail                                                                                                                                                                                                                                                                                                                                                                                                             |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Task**         | Prefetch likely next URLs in parallel with model inference                                                                                                                                                                                                                                                                                                                                                         |
| **Actions**      | After each Navigator Engine call, if the model's action suggests a navigation (CLICK on a link), extract the target URL from the AX tree or DOM. Issue a prefetch (DNS resolve + TCP/TLS handshake + optional initial request) for that URL into the Ghost Tab's connection pool. Prefetch runs concurrently with model inference time for the next step. Expose a `prefetch(url)` API in the orchestration layer. |
| **Acceptance**   | Prefetching reduces TTFB by 150-300ms on predicted navigations. Prefetch does not trigger full page loads.                                                                                                                                                                                                                                                                                                         |
| **Req Coverage** | Spec §01 (Predictive Prefetch), Performance target (150-300ms TTFB reduction)                                                                                                                                                                                                                                                                                                                                      |

### 5.4 Network Error Handling (Structured)

| Item             | Detail                                                                                                                                                                                                                                          |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Catch all network errors at the orchestration layer and convert to structured objects                                                                                                                                                           |
| **Actions**      | Intercept DNS failures, connection timeouts, TLS errors, HTTP 4xx, and 5xx responses via CDP Network events. Convert to `{status, url, retryable, errorType}`. Route to Navigator Engine instead of letting the Ghost Tab render an error page. |
| **Acceptance**   | DNS failure returns `{status: null, url: ..., retryable: true, errorType: 'DNS_FAILURE'}`. HTTP 503 returns `{status: 503, url: ..., retryable: true}`. Navigator Engine never receives a screenshot of an error page for network errors.       |
| **Req Coverage** | Spec §01 (Error Handling — structured errors)                                                                                                                                                                                                   |

### 5.5 HTTP Cache Partitioning

| Item             | Detail                                                                                                                                                                                                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Task**         | Configure per-BrowserContext cache partitions with overridable TTL                                                                                                                                                                                                                                                                        |
| **Actions**      | Each BrowserContext already gets its own cache via partition isolation. Implement application-level TTL override: allow the orchestration layer to set cache behavior per session (e.g., force refresh for time-sensitive data, long cache for static reference sites). Layer the observation cache (Phase 4.4) on top of the HTTP cache. |
| **Acceptance**   | Repeat visits to the same URL within a session use cached resources. Cache override forces fresh fetch when needed.                                                                                                                                                                                                                       |
| **Req Coverage** | Spec §01 (HTTP Cache), §07 (observation cache integration)                                                                                                                                                                                                                                                                                |
